# Руководство по установке

## Системные требования

В разделе перечислены пре-реквизиты и требования к окружению (программному и аппаратному)
для установки продукта, в том числе рекомендуемые настройки безопасности окружения.
Также в разделе представлен перечень внешних продуктов, используемых для установки,
настройки и контроля с указанием выполняемых ими функций.

Установка программного продукта для промышленной эксплуатации предполагает выделение 2х
серверов приложений и 2х серверов БД. Отдельная пара серверов для DevOps Pipeline Management
(DPM) и для Quality Gates Management& (QGM).

### Требования к VM/bare metal для DPM

Минимальные системные требования:
* Сервер приложений – 4 CPU/8 Gb RAM/30 Gb HDD;
* Сервер БД – 4 CPU/8 Gb RAM, рост БД в среднем ~5 Gb/мес.

Требования к промышленной нагрузке рассчитываются индивидуально в зависимости от
предполагаемой нагрузки.

### Требования к VM/bare metal для QGM

Минимальные системные требования:
* Сервер приложений – 4 CPU/8 Gb RAM/30 Gb HDD;
* Сервер БД – 4 CPU/8 Gb RAM, рост БД в среднем ~5 Gb/мес.

Требования к промышленной нагрузке рассчитываются индивидуально в зависимости от
предполагаемой нагрузки.

### Требования к пререквизитам

Для корректного функционирования программного продукта необходимо развернуть следующие
пререквизиты согласно инструкциям с сайта производителя.
Указанные ниже требования должны быть выполнены как для серверов DPM, так и для серверов
QGM.

Для сервера приложений:
* Java 8 (Open JDK);
* WildFly 20.0.1.Final (Servlet-Only Distribution/Java EE Full & Web Distribution).

Для сервера БД:
* Postgres v11.15. (рекомендован Platform V Pangolin SE)

## Установка

В разделе по шагам описан процесс установки программного компонента и всех входящих в его
состав компонентов, включая рекомендованные настройки.

Также приведен порядок установки и параметры настройки программного и аппаратного
обеспечения среды функционирования: операционная система, иное системное ПО (настройки
СУБД, сервера приложений, веб-сервера, иные необходимые сервисы, используемые сетевые
порты, права пользователей, права доступа к файлам и каталогам, аудит и т.п.), программные и
программно-аппаратные СЗИ и СКЗИ (при наличии), серверное и сетевое оборудование,
оборудование АРМ пользователей (при наличии).

Дополнительные файлы, описанные в данном разделе, находятся в приложенном архиве setup.zip

### Состав дистрибутива DPM

* dpm.war
* dpm-artifact-sync-service.war
* dpm-atlas-service.war
* dpm-auth-service.war
* dpm-delegated-service.war
* dpm-frontend-service.war
* dpm-log-service.war
* dpm-mail-service.war
* dpm-processing-service.war
* dpm-relay-service.war
* dpm-service-discovery.war

### Порядок установки DPM

1. Создать БД ‘dpm’.
2. Отредактировать файл {wf_home}/bin/standalone.conf, добавить содержимое файла
java_opts_dpm.txt в следующий раздел, прим.
```
# Specify options to pass to the Java VM.
if [ "$JAVA_OPTS" = "x" ]; then
```
Обратите внимание, что в процессе заполнения некоторые переменные необходимо будет задать,
исходя из конфигурации сервера. В файле указаны параметры при работе с минимальным
количеством ресурсов.
3. Положить файл module.xml и postgresql-42.1.4.jar из папки driver в следующую папку
(недостающие промежуточные папки создать) {wf_home}/modules/org/postgresql/main
4. Создать файл с названием x501 и заполнить его одной строчкой с произвольным набором
букв и цифр длиной 128 символов, в верхнем регистре (прим.
88115D3BADCF728025F026C52F50215CD850BBBD7BB188B307322804B0EC4650901EBE9C
38685A41819855D1CC860647F4E4F3166F1F52E87499A0F553F5EC47). Поместите его по
следующему пути {wf_home}/standalone/configuration. Этот ключ (соль) будет использован
при преобразовании чувствительных данных.
5. Отредактировать файл {wf_home}/standalone/configuration/standalone.xml, добавить
содержимое файла standalone_dpm.xml в соответствующие разделы вышеуказанного
файла. Обратите внимание, что в процессе заполнения некоторые переменные необходимо
будет задать, исходя из конфигураций внешних зависимостей (БД, Ldap, DPM и др.).
6. Сделать рестарт сервиса WF, убедится, что он запустился
7. Осуществить деплой приложений, через CLI или административную панель (localhost:9990,
admin/admin) в следующей последовательности
  1. dpm.war – в процессе деплоя, в том числе, выполняет основные liquibase скрипты
  2. service-discovery.war
  3. все оставшиеся сервисы, в любом порядке
8. Зайти на http://{dpm-ipAddress}:8080/front/main/loginpage и попытаться авторизоваться.

### Состав дистрибутива QGM
* qgm.war
* applicability-service.war
* elk-service.war
* validation-service.war
* service-discovery.war

### Порядок установки QGM
1. Создать БД ‘qgm’, создать доп. схему, ‘qg_applicability’, в этой БД.
2. Отредактировать файл {wf_home}/bin/standalone.conf, добавить содержимое файла
java_opts_qgm.txt в следующий раздел, прим.
```
# Specify options to pass to the Java VM.
if [ "$JAVA_OPTS" = "x" ]; then
```
Обратите внимание, что в процессе заполнения некоторые переменные необходимо будет задать,
исходя из конфигурации сервера. В файле указаны параметры при работе с минимальным
количеством ресурсов.
3. Отредактировать файл {wf_home}/standalone/configuration/standalone.xml, добавить
содержимое файла standalone_qgm.xml в соответствующие разделы вышеуказанного
файла. Обратите внимание, что в процессе заполнения некоторые переменные необходимо
будет задать, исходя из конфигураций внешних зависимостей (БД, Ldap, DPM и др.).
4. Сделать рестарт сервиса WF, убедится, что он запустился.
5. Осуществить деплой приложений, через CLI или административную панель (localhost:9990,
admin/admin) в следующей последовательности:
  1. qgm.war – в процессе деплоя, в том числе, выполняет основные liquibase скрипты;
  2. service-discovery.war;
  3. все оставшиеся сервисы, в любом порядке.
6. Зайти на http://{ip-address}:8080/qgm/ui/login и попытаться авторизоваться.

### Настройка DPM

Авторизуйтесь в DPM с правами администратора (как описано в последнем пункте раздела 2.2).

#### Первоначальная настройка DPM

Настройка осуществляется от глобального администратора. Чтобы перейти к настройкам DPM
необходимо кликнуть по шестерёнке, которая расположена в верхнем правом углу рядом с иконкой
пользователя.

#### Включение фиче флагов

В левом меню кликнуть список фиче-флагов.
Если планируется интеграция с QGM сервисом активировать qgmIntegration.
Остальные флаги можно включить позже.

#### Создание этапов

В левом меню кликнуть Steps.
Добавить несколько этапов через нажатие кнопки Create new step.

#### Создание флагов

В левом меню кликнуть список Quality Gates.
Добавить общие флаги, которые могут быть использованы во всех проектах.

#### Создание домена

В левом меню кликнуть Домены Delegated.
Добавить домен в соответствии с настройками сервера Wildfly: указать значение параметра dpmservice.domain-name или relay.currentDomain.

#### Настройка внешних приложений

В левом меню кликнуть External Apps.

В общем случае требуется добавить как минимум по одному приложению типа Nexus Public, Jenkins,
QGM.

В URL можно использовать доменное имя или ip адрес.

### Создание первого проекта

Владельцем проекта может быть только пользователь не имеющий прав глобального
администратора.

Пользователь создаётся при первом входе в DPM (без этого действия его нельзя назначить
ответственным за проект).

Создание проекта осуществляется нажатием кнопки Создать проект на главной странице.
Поиск пользователя осуществляется по ФИО (не по логину).
